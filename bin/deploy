#!/bin/bash
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
cd "$SCRIPT_DIR" || exit

THEME_NAME="Cristian/Quiroz"
LANGUAGES_BACKEND="es_CL en_US"
LANGUAGES_FRONTEND="es_CL"
DEPLOYMENT_JOBS=2

set -e

./app rm -rf generated/* vendor/composer/ClassLoader.php pub/static/* var/cache/*
./app composer install --no-interaction --no-progress --prefer-dist --no-dev
./redis-cache redis-cli flushall
./magento set:up
./magento s:d:c
./magento s:s:d -j$DEPLOYMENT_JOBS -aadminhtml $LANGUAGES_BACKEND
./magento s:s:d -j$DEPLOYMENT_JOBS -afrontend --theme $THEME_NAME $LANGUAGES_FRONTEND
./varnish varnishadm "ban req.url ~ ."
./magento c:enable
./magento maintenance:disable

docker compose restart varnish web rabbitmq php redis